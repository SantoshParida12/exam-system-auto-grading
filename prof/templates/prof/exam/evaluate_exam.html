{% extends 'prof/base/base.html' %}

{% block title %}Evaluate Exam{% endblock title %}
{% block navbar_title %}Evaluate Exam: {{ exam.name }}{% endblock navbar_title %}

{% block body %}
<div class="container py-4">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-3 mb-3">
        <h2 class="h4 mb-0"><i class="fa fa-check-double text-success"></i> Evaluate: {{ exam.name }}</h2>
        <div class="text-muted small">Use the table to review answers and assign scores</div>
    </div>
    <form method="POST">
        {% csrf_token %}
        {% if messages %}
            <ul class="messages">
                {% for message in messages %}
                    <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
                {% endfor %}
            </ul>
        {% endif %}
        <div class="card shadow-sm border-0 rounded-4">
        <div class="card-body p-0">
        <div class="table-responsive">
        <table class="table align-middle mb-0" id="gradingTable">
            <thead class="table-light">
                <tr>
                    <th>Student</th>
                    <th>Answers</th>
                    <th>Score</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in student_data %}
                <tr>
                    <td>{{ entry.stu_exam.student.username }}</td>
                    <td>
                        <ul class="mb-0 ps-3">
                        {% for ans in entry.answers %}
                            <li>
                                <strong>Q:</strong> {{ ans.question }}<br>
                                {% if ans.subjective_answer %}
                                    {% if ans.subjective_answer.text_answer %}
                                        <strong>Text Answer:</strong> {{ ans.subjective_answer.text_answer }}<br>
                                    {% endif %}
                                    {% if ans.subjective_answer.image_answer %}
                                        <strong>Image Answer:</strong><br>
                                        <img src="{{ ans.subjective_answer.image_answer.url }}" class="img-thumbnail" style="max-width:220px;"/><br>
                                        {% if ans.subjective_answer.ocr_text %}
                                            <strong>OCR Extracted Text:</strong><br>
                                            <div class="border rounded p-2 bg-light mb-2">
                                                {{ ans.subjective_answer.ocr_text }}
                                            </div>
                                        {% endif %}
                                        {% if ans.subjective_answer.marks %}
                                            <strong>Automated Marks:</strong> {{ ans.subjective_answer.marks }}/5<br>
                                        {% endif %}
                                        {% if ans.subjective_answer.feedback %}
                                            <strong>Automated Feedback:</strong> {{ ans.subjective_answer.feedback }}<br>
                                        {% endif %}
                                    {% endif %}
                                {% else %}
                                    <em class="text-danger">No answer submitted.</em>
                                    <br><small class="text-muted">Student has not provided any answer for this question yet.</small>
                                {% endif %}
                            </li>
                        {% endfor %}
                        </ul>
                    </td>
                    <td>
                        <input type="number" name="score_{{ entry.stu_exam.id }}" value="{{ entry.stu_exam.score }}" min="0" class="form-control"/>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
        </div>
        </div>
        <div class="d-grid gap-2 d-sm-flex mt-3">
            <button type="submit" class="btn btn-success" id="saveScores"><i class="fa fa-save"></i> Save Scores</button>
            <a href="{% url 'prof:index' %}" class="btn btn-primary"><i class="fa fa-home"></i> Go to Dashboard</a>
        </div>
    </form>
</div>
<script>
// Keyboard shortcuts: n/p to navigate rows, s to save
(function(){
  var table = document.getElementById('gradingTable');
  if (!table) return;
  var rows = Array.from(table.querySelectorAll('tbody tr'));
  var idx = 0;
  function focusRow(i){
    if (rows[i]) {
      var input = rows[i].querySelector('input[type="number"]');
      if (input) input.focus();
    }
  }
  document.addEventListener('keydown', function(e){
    if (e.target && (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA')) return;
    if (e.key === 'n' || e.key === 'ArrowDown') { idx = Math.min(idx+1, rows.length-1); focusRow(idx); e.preventDefault(); }
    if (e.key === 'p' || e.key === 'ArrowUp') { idx = Math.max(idx-1, 0); focusRow(idx); e.preventDefault(); }
    if (e.key.toLowerCase() === 's') { var btn = document.getElementById('saveScores'); if (btn) btn.click(); e.preventDefault(); }
  });
})();
</script>
{% endblock body %} 